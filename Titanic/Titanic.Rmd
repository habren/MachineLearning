---
title: "Titanic suvivor prediction"
output:
  html_document: 
    toc: true
    toc_float: false
  pdf_document: default
  md_document:
    variant:
      markdown_github
  revealjs::revealjs_presentation: 
    theme: league
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```




## 

## 加载训练数据集
通过如下代码加载训练数据集并存于train中

```{r "Loading necessary libraries", echo=FALSE, results='hide', message=FALSE}
library(readr) # File read / write
library(ggplot2) # Data visualization
library(ggthemes) # Data visualization
library(scales) # Data visualization
library(plyr)
library(stringr) # String manipulation
library(InformationValue) # IV / WOE calculation
library(MLmetrics) # Mache learning metrics.e.g. Recall, Precision, Accuracy, AUC
library(rpart)
library(randomForest) # Random Forest
library(dplyr) # Data manipulation
library(e1071) # SVM
```


```{r echo=TRUE, results='hide', message=FALSE, cache=TRUE}
train <- read_csv("train.csv")
test <- read_csv("test.csv")
full <- bind_rows(train, test)
train.records <- nrow(train)
full$Fare[is.na(full$Fare)] <- median(full$Fare[!is.na(full$Fare)])
```




```{r}
full$Title <- gsub('(.*, )|(\\..*)', '', full$Name)
full$Title[full$Title %in% c('Mlle', 'Ms')] <- 'Miss'
full$Title[full$Title =='Mme'] <- 'Mrs'
full$Title[!full$Title %in% c('Master', 'Miss', 'Mr', 'Mrs', 'Dr')] <- 'Others'
full$Title <- as.factor(full$Title)
```


```{r cache=TRUE}
ggplot(data = full[1:nrow(train),], mapping = aes(x = Title, y = ..count.., fill=factor(Survived))) + geom_bar(stat = "count", position='dodge') + labs(title = "How Title impact survivor", x = "Title", y = "Count", fill = "Survived")
WOETable(X=full$Title[1:nrow(train)], Y=full$Survived[1:nrow(train)])
IV(X=full$Title[1:nrow(train)], Y=full$Survived[1:nrow(train)])
```




```{r}
full$Mother <- 'Non-mother'
full$Mother[as.integer(full$Age) > 20 & (!full$Title %in% c('Mr','Miss')) & as.integer(full$Parch) > 0] <- 'Mother'
full$Mother <- as.factor(full$Mother)

ggplot(data = full[1:nrow(train),], mapping = aes(x = factor(Mother), y = ..count.., fill=factor(Survived))) + geom_bar(stat = "count", position='dodge') + labs(title = "How Mother impact survivor", x = "Mother", y = "Count", fill = "Survived")
WOETable(X=full$Mother[1:nrow(train)], Y=full$Survived[1:nrow(train)])
IV(X=full$Mother[1:nrow(train)], Y=full$Survived[1:nrow(train)])
```







```{r cache=TRUE}
ggplot(data = full[1:nrow(train),], mapping = aes(x = factor(Pclass), y = ..count.., fill=factor(Survived))) + geom_bar(stat = 'count', width = 0.5, position = position_dodge(1)) + labs(title = "How Pclass impact survivor", x = "Pclass", y = "Count", fill = "Survived")
WOETable(X=factor(full$Pclass[1:nrow(train)]), Y=full$Survived[1:nrow(train)])
IV(X=factor(full$Pclass[1:nrow(train)]), Y=full$Survived[1:nrow(train)])
```






```{r results='hide'}
full$Pclass <- as.factor(full$Pclass)
full$Sex <- as.factor(full$Sex)
full$Survived <- as.factor(full$Survived)
```






```{r cache=TRUE}
ggplot(data = full[1:nrow(train),], mapping = aes(x = factor(Sex), y = ..count.., fill=factor(Survived))) + geom_bar(stat = 'count', position='dodge') + labs(title = "How Sex impact survivor", x = "Sex", y = "Count", fill = "Survived")
WOETable(X=factor(full$Sex[1:nrow(train)]), Y=full$Survived[1:nrow(train)])
IV(X=factor(full$Sex[1:nrow(train)]), Y=full$Survived[1:nrow(train)])
```





```{r cache=TRUE}
ggplot(data = full[1:nrow(train),], mapping = aes(x = factor(SibSp), y = ..count.., fill=factor(Survived))) + geom_bar(stat = 'count', position='dodge') + labs(title = "How SibSp impact survivor", x = "Sibsp", y = "Count", fill = "Survived")
WOETable(X=factor(full$SibSp[1:nrow(train)]), Y=full$Survived[1:nrow(train)])
IV(X=factor(full$SibSp[1:nrow(train)]), Y=full$Survived[1:nrow(train)])
```





```{r cache=TRUE}
ggplot(data = full[1:nrow(train),], aes(x = sapply(full$Age[1:nrow(train)], function(x){ifelse(is.na(x), 100, x)}), color=factor(Survived))) + geom_line(aes(file=..count..), stat = 'bin', binwidth=3)  + labs(title = "How Age impact survivor", x = "Age", y = "Count", fill = "Survived")
```





```{r cache=TRUE}
df <- data.frame(Age <- sapply(full$Age[1:nrow(train)], FUN=function(x){if(is.na(x)){" NA"} else if(x < 15){"0-15"} else if (x < 35) {" 15-35"} else if(x < 60) {" 35-60"}  else {"60"}}), Survived <- full$Survived[1:nrow(train)])
ggplot(data = df, mapping = aes(x = factor(Age), y = ..count.., fill=factor(Survived))) + geom_bar(stat = "count", position='dodge') + labs(title = "How Age impact survivor", x = "Age", y = "Count", fill = "Survived")
WOETable(X=df$Age, Y=df$Survived)
IV(X=df$Age, Y=df$Survived)
```





```{r cache=TRUE}
df <- data.frame(Age <- sapply(full$Age[1:nrow(train)], FUN=function(x){if((!is.na(x)) && (x<18)){"teenager"} else {"adult"}}), Survived <- full$Survived[1:nrow(train)])
ggplot(data = df, mapping = aes(x = factor(Age), y = ..count.., fill=factor(Survived))) + geom_bar(stat = "count", position='dodge') + labs(title = "How Age impact survivor", x = "Age", y = "Count", fill = "Survived")
WOETable(X=df$Age, Y=df$Survived)
IV(X=df$Age, Y=df$Survived)
```



```{r}
full$Age <- as.factor(sapply(full$Age, function(x){if(is.na(x)){" N-A"} else if(x < 15){"0-15"} else if (x < 35) {" 15-35"} else if(x < 60) {" 35-60"}  else {"old"}}))
```








```{r cache=TRUE}
ggplot(data = full[1:nrow(train),], aes(x = Fare, color=factor(Survived))) + geom_line(aes(file=..count..), stat = 'bin', binwidth=100)  + labs(title = "How Fare impace survivor", x = "Fare", y = "Count", fill = "Survived")
```





```{r cache=TRUE}
missing.embarked <- full[is.na(full$Embarked),]
missing.embarked[c('Pclass', 'Fare', 'Embarked')]
ggplot(full[!is.na(full$Embarked),], aes(x=Embarked, y=Fare, fill=factor(Pclass))) + geom_boxplot() + geom_hline(aes(yintercept=80), color='red', linetype='dashed', lwd=2) + scale_y_continuous(labels=dollar_format()) + theme_few()
```



从上图可知缺失Embark信息的两名乘客的Fare为$80，Pclass为1。而Fare为$80，Pclass为1的乘客最有可能从'C'登船，因此这里将缺失Embark信息的两名乘客的Embark设置为'C'


```{r}
full$Embarked[is.na(full$Embarked)] <- 'C'
```






```{r cache=TRUE}
ggplot(data = full[1:nrow(train),], mapping = aes(x = factor(Embarked), y = ..count.., fill=factor(Survived))) + geom_bar(stat = "count", position='dodge') + labs(title = "How Pclass impact survivor", x = "Embarked", y = "Count", fill = "Survived")
```




```{r results='hide'}
full$Embarked <- as.factor(ifelse(is.na(full$Embarked), "N-A", full$Embarked))
```





```{r cache=TRUE}
df <- data.frame(Fare <- sapply(full$Fare[1:nrow(train)], FUN=function(x){if(x<20){" 0-20"} else if (x < 40) {" 20-40"} else if(x<60){" 40-60"} else if(x < 80){" 60-80"} else if (x< 100){" 80-100"}else if(x < 200){"100-200"} else if(x < 300) {"200-300"} else if (x<400){"300-400"} else {"400-10000"}}), Survived <- full$Survived[1:nrow(train)])
ggplot(data = df, mapping = aes(x = factor(Fare), y = ..count.., fill=factor(Survived))) + geom_bar(stat = "count", position='dodge') + labs(title = "How Fare impact survivor", x = "Fare", y = "Count", fill = "Survived")
WOETable(X=df$Fare, Y=df$Survived)
IV(X=df$Fare, Y=df$Survived)
```






```{r cache=TRUE}
df <- data.frame(Fare <- sapply(full$Fare[1:nrow(train)], FUN=function(x){if(x<10){" 0-10"} else if (x < 20) {" 10-20"} else if(x<30){" 20-30"} else if(x < 40){" 30-40"} else if(x<50){" 40-50"} else if(x < 60){" 50-60"} else if(x<70){" 60-70"} else if(x < 80){" 70-80"} else if(x<90){" 80-90"} else if (x< 100){" 80-100"}else if(x < 200){"100-200"} else if(x < 300) {"200-300"} else if (x<400){"300-400"} else {"400-10000"}}), Survived <- full$Survived[1:nrow(train)])
ggplot(data = df, mapping = aes(x = factor(Fare), y = ..count.., fill=factor(Survived))) + geom_bar(stat = "count", position='dodge') + labs(title = "How Fare impact survivor", x = "Fare", y = "Count", fill = "Survived")
WOETable(X=df$Fare, Y=df$Survived)
IV(X=df$Fare, Y=df$Survived)
```


```{r results='hide'}
full$Fare <- as.factor(sapply(full$Fare, FUN=function(x){if(x<10){" 0-10"} else if (x < 20) {" 10-20"} else if(x<30){" 20-30"} else if(x < 40){" 30-40"} else if(x<50){" 40-50"} else if(x < 60){" 50-60"} else if(x<70){" 60-70"} else if(x < 80){" 70-80"} else if(x<90){" 80-90"} else if (x< 100){" 90-100"}else if(x < 200){"100-200"} else if(x < 300) {"200-300"} else if (x<400){"300-400"} else {"400-10000"}}))
```














```{r cache=TRUE}
df <- data.frame(Cabin <- sapply(full$Cabin[1:nrow(train)], FUN=function(x){ifelse(is.na(x), "X", "Y")}), Survived <- full$Survived[1:nrow(train)])
ggplot(data = df, mapping = aes(x = factor(Cabin), y = ..count.., fill=factor(Survived))) + geom_bar(stat = "count", position='dodge') + labs(title = "How Cabin impact survivor", x = "Cabin", y = "Count", fill = "Survived")
WOETable(X=df$Cabin, Y=df$Survived)
IV(X=df$Cabin, Y=df$Survived)
```




```{r cache=TRUE}
df <- data.frame(Cabin <- sapply(full$Cabin[1:nrow(train)], FUN=function(x){ifelse(is.na(x), "X", str_sub(x, start=1, end=1))}), Survived <- full$Survived[1:nrow(train)])
ggplot(data = df, mapping = aes(x = factor(Cabin), y = ..count.., fill=factor(Survived))) + geom_bar(stat = "count", position='dodge') + labs(title = "How Cabin impact survivor", x = "Cabin", y = "Count", fill = "Survived")
WOETable(X=df$Cabin, Y=df$Survived)
IV(X=df$Cabin, Y=df$Survived)
```



```{r results='hide'}
full$Cabin <- as.factor(sapply(full$Cabin, FUN=function(x){ifelse(is.na(x), "X", str_sub(x, start=1, end=1))}))
```









```{r results='hide'}
full$Family <- as.factor(full$SibSp + full$Parch)
```


```{r cache=TRUE}
ggplot(data = full[1:nrow(train),], mapping = aes(x = factor(Family), y = ..count.., fill=factor(Survived))) + geom_bar(stat = "count", position='dodge') + labs(title = "How Family impact survivor", x = "Family", y = "Count", fill = "Survived")
WOETable(X=full$Family[1:nrow(train)], Y=full$Survived[1:nrow(train)])
IV(X=full$Family[1:nrow(train)], Y=full$Survived[1:nrow(train)])
```




```{r cache=TRUE}
df <- data.frame(Family=sapply(full$Family[1:nrow(train)], function(x){if(as.integer(x)<=1){'Singleton'} else if(as.integer(x) < 4){'small'} else {'large'}}), Survived=full$Survived[1:nrow(train)])
ggplot(data = df, mapping = aes(x = factor(Family), y = ..count.., fill=factor(Survived))) + geom_bar(stat = "count", position='dodge') + labs(title = "How Family impact survivor", x = "Family", y = "Count", fill = "Survived")
WOETable(X=df$Family, Y=df$Survived)
IV(X=df$Family, Y=df$Survived)
```






```{r}
set.seed(256)
cv_train_sample <- sample(1:nrow(train), as.integer(0.9 * nrow(train)), replace = TRUE)
cv_train <- full[cv_train_sample,]
cv_test <- full[1:nrow(train),][-cv_train_sample,]
cv_test_true <- full$Survived[1:nrow(train)][-cv_train_sample]
```


```{r "training model"}
train.data <- full[1:nrow(train),]

model.features <- c('Age', 'Fare', 'Cabin', 'Embarked', 'Pclass', 'Sex', 'Family', 'Title', 'Mother')
model.formula <- as.formula(paste('Survived ~ ', paste(model.features, collapse=' + ')))

lrmodel <- glm(formula=model.formula, data=train.data, family=binomial)

rfmodel <- randomForest(formula=model.formula, data=train.data, na.action = na.omit)
plot(rfmodel)

svmmodel <- svm(formula=model.formula, data=train.data, na.action = na.omit)


models <- vector(mode='list', length=3)
models[[1]] <- lrmodel
models[[2]] <- rfmodel
models[[3]] <- svmmodel

model.name <- c('Linear regression', 'Random forest', 'Support vector machine')
model.name


```




```{r 'cross validation'}
summary(lrmodel)
summary(rfmodel)
summary(svmmodel)
print(lrmodel)
print(rfmodel)
print(svmmodel)
cv_lr_predict_test <- ifelse(predict(lrmodel, newdata=cv_test, type="response") > 0.5, 1, 0)
cv_rf_predict_test <- predict(rfmodel, newdata=cv_test, type="response")
cv_svm_predict_test <- predict(svmmodel, newdata=cv_test, type="response")
cv_combined_predict_test <- as.integer(cv_lr_predict_test) + as.integer(cv_rf_predict_test) + as.integer(cv_svm_predict_test)
cv_combined_predict_test <- ifelse(cv_combined_predict_test >=4, 1, 0)



Recall(cv_test_true, cv_lr_predict_test)
Precision(cv_test_true, cv_lr_predict_test)
Accuracy(cv_lr_predict_test, cv_test_true)
AUC(cv_lr_predict_test, cv_test_true)

Recall(cv_test_true, cv_rf_predict_test)
Precision(cv_test_true, cv_rf_predict_test)
Accuracy(cv_rf_predict_test, cv_test_true)
AUC(cv_rf_predict_test, cv_test_true)
importance(rfmodel)


Recall(cv_test_true, cv_svm_predict_test)
Precision(cv_test_true, cv_svm_predict_test)
Accuracy(cv_svm_predict_test, cv_test_true)
AUC(cv_svm_predict_test, cv_test_true)

Recall(cv_test_true, cv_combined_predict_test)
Precision(cv_test_true, cv_combined_predict_test)
Accuracy(cv_combined_predict_test, cv_test_true)
AUC(cv_combined_predict_test, cv_test_true)
```



```{r 'predicting'}
test.data <- full[(nrow(train)+1):(nrow(train)+nrow(test)), model.features]

svm.predict <- predict(svmmodel, newdata=test.data, type="response")
rf.predict <- predict(rfmodel, newdata=test.data, type="response")
lr.predict <- ifelse(predict(lrmodel, newdata=test.data, type="response") > 0.5, 1, 0)


combined.predict <- as.integer(svm.predict) + as.integer(rf.predict) + as.integer(lr.predict)
combined.predict <- sapply(combined.predict, function(x){if(x>4){1} else{0}})

test.result <- data.frame(full$PassengerId[(nrow(train)+1):(nrow(full))], Survived=combined.predict)
colnames(test.result) <- c('PassengerId', 'Survived')

write.csv(test.result, file="result.csv", row.names=FALSE, quote=FALSE)
table(full$Fare)
```










